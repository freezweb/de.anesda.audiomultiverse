version: '3.8'

services:
  audiomultiverse-server:
    build:
      context: ..
      dockerfile: server/Dockerfile
    container_name: audiomultiverse
    restart: unless-stopped
    
    # Netzwerk-Modus: host für AES67/PTP (benötigt Multicast)
    network_mode: host
    
    # Alternativ: Bridge-Modus mit Port-Mapping (kein AES67)
    # ports:
    #   - "8080:8080"
    
    volumes:
      # Konfiguration
      - ./config.toml:/app/config.toml:ro
      
      # MIDI-Mappings (optional)
      - ./midi-mappings:/app/midi-mappings:ro
      
      # Scenes/Presets persistent speichern
      - audiomultiverse-data:/app/data
    
    # ALSA/JACK Zugriff (wenn lokale Audio-Geräte verwendet werden)
    devices:
      - /dev/snd:/dev/snd
    
    # Für Echtzeit-Audio-Performance
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      memlock:
        soft: -1
        hard: -1
    
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  audiomultiverse-data:
